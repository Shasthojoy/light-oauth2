<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Proof key for code exchange (PKCE) - Light OAuth2 - OAuth2 Serivces based on light-4j</title>
    <meta name="generator" content="Hugo 0.20.6" />

    
    <meta name="description" content="Light OAuth2 Docs">
    
    <link rel="canonical" href="https://networknt.github.io/light-oauth2/services/pkce/">
    
    <meta name="author" content="Steve Hu">
    

    <meta property="og:url" content="https://networknt.github.io/light-oauth2/services/pkce/">
    <meta property="og:title" content="Light OAuth2 - OAuth2 Serivces based on light-4j">
    <meta property="og:image" content="https://networknt.github.io/light-oauth2/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Light OAuth2 - OAuth2 Serivces based on light-4j">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://networknt.github.io/light-oauth2/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://networknt.github.io/light-oauth2/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://networknt.github.io/light-oauth2/fonts/icon.eot');
        src: url('https://networknt.github.io/light-oauth2/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://networknt.github.io/light-oauth2/fonts/icon.woff')
               format('woff'),
             url('https://networknt.github.io/light-oauth2/fonts/icon.ttf')
               format('truetype'),
             url('https://networknt.github.io/light-oauth2/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://networknt.github.io/light-oauth2/stylesheets/application.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-oauth2/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-oauth2/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-oauth2/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://networknt.github.io/light-oauth2/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-teal">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Proof key for code exchange (PKCE)
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/stevehu" title="@stevehu on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/networknt/light-oauth2" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://networknt.github.io/light-oauth2/images/logo.png">
        </div>
      
      <div class="name">
        <strong>Light OAuth2 - OAuth2 Serivces based on light-4j <span class="version">1.3.3</span></strong>
        
          <br>
          networknt/light-oauth2
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/networknt/light-oauth2/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/networknt/light-oauth2/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Getting started" href="https://networknt.github.io/light-oauth2/getting-started/">
	
	Getting started
</a>



  
</li>



<li>
  
    



<a  title="Architecture" href="https://networknt.github.io/light-oauth2/architecture/">
	
	Architecture
</a>



  
</li>



<li>
  
    



<a  title="Services" href="https://networknt.github.io/light-oauth2/services/">
	
	Services
</a>



  
</li>



<li>
  
    



<a  title="Tutorials" href="https://networknt.github.io/light-oauth2/tutorials/">
	
	Tutorials
</a>



  
</li>



<li>
  
    



<a  title="Examples" href="https://networknt.github.io/light-oauth2/example/">
	
	Examples
</a>



  
</li>



<li>
  
    



<a  title="Tools" href="https://networknt.github.io/light-oauth2/tools/">
	
	Tools
</a>



  
</li>



<li>
  
    



<a  title="References" href="https://networknt.github.io/light-oauth2/reference/">
	
	References
</a>



  
</li>



<li>
  
    



<a  title="Issues &amp; Help" href="https://github.com/networknt/light-oauth2/issues">
	
	Issues &amp; Help
</a>



  
</li>



<li>
  
    



<a  title="Roadmap" href="https://networknt.github.io/light-oauth2/roadmap/">
	
	Roadmap
</a>



  
</li>



<li>
  
    



<a  title="License" href="https://www.apache.org/licenses/LICENSE-2.0">
	
	License
</a>



  
</li>



<li>
  
    



<a  title="Introduction" href="https://networknt.github.io/light-oauth2/index.html">
	
	Introduction
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          

          
          <li>
            <a href="https://github.com/stevehu" target="_blank" title="@stevehu on GitHub">
              @stevehu on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:stevehu@gmail.com" title="Email of stevehu@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Proof key for code exchange (PKCE) </h1>

			

<p>Public OAuth clients that use the code grant and run on smartphones are susceptible to
a code interception attack. Fortunately, this attack can be successfully prevented by
establishing a secure binding between the authorisation request and the subsequent token
request.</p>

<p>The OAuth work group devised an official mini extension of the protocol for that, called
Proof Key for Code Exchange (PKCE) and published in September 2015 as RFC 7636. It is a
countermeasure against the authorization code interception attack.</p>

<h2 id="how-does-pkce-work">How does PKCE work?</h2>

<ul>
<li>The client creates a large random string called the code verifier.</li>
<li>The client then computes its SHA-256 hash, called the code_challenge.</li>
<li>The client passes the code_challenge and code_challenge_method (a keyword for the SHA-256
hash) along with the regular authorisation request parameters to the OAuth2 server. The
server stores them until a token request is received by the client.</li>
<li>When the client receives the authorisation code, it makes a token request with the
code_verifier included. The OAuth2 server recomputes the code challenge, and if it matches
the original one, releases the requested tokens.</li>
</ul>

<p>PKCE essentially works by preventing a malicious app or code had intercepted the code (as it
was passed from the system browser / the OS to the app) from exchanging it for a token.</p>

<p>The latest release of the light-oauth2 server adds complete support for PKCE. In order to make
use of it a public client just needs to set the appropriate PKCE request parameters. The server
will take care of the rest.</p>

<p>We also provide utility class CodeVerifierUtil in light-4j utility module to assist Java client
to create code verifier and code challenge.</p>

<h2 id="pkce-authorization-request">PKCE Authorization Request</h2>

<p>An authorization request that uses PKCE goes out with</p>

<p>code_challenge parameter and optionally with code_challenge_method parameter.</p>

<p>The value of code_challenge parameter is computed by applying a code challenge method (= computation
logic) to a code verifier.</p>

<p>A code verifier itself is a random string using characters of [A-Z] / [a-z] / [0-9] / &ldquo;-&rdquo; / &ldquo;.&rdquo; / &ldquo;_&rdquo; / &ldquo;~&ldquo;,
with a minimum length of 43 characters and a maximum length of 128 characters.</p>

<p>The defined code challenge methods are plain and S256. Respective computation logics to convert a code
verifier into a code challenge are as follows.</p>

<ul>
<li><p>plain code_challenge = code_verifier</p></li>

<li><p>S256  code_challenge = BASE64URL-ENCODE(SHA256(ASCII(code_verifier)))</p></li>
</ul>

<p>The plain method does not change the input, so the value of code_verifier and the resultant value
of code_challenge are equal.</p>

<p>The S256 method computes the SHA-256 hash of the input and then encodes the hash value using Base64-URL.</p>

<p>When the used code challenge method is S256, a client application must tell it by including
code_challenge_method=S256 parameter in an authorization request. When code_challenge_method parameter
is omitted, an authorization server assumes plain as the default value.</p>

<h2 id="pkce-authorization-response">PKCE Authorization Response</h2>

<p>After generating an authorization code, an authorization server saves it into its in-memory data grid
with the code challenge and the code challenge method contained in the authorization request.</p>

<p>The authorization server will use the saved code challenge and the code challenge method later to
verify a token request from the client application.</p>

<p>A response from the authorization endpoint has nothing special for PKCE. It&rsquo;s a normal response as usual.</p>

<h2 id="pkce-token-request">PKCE Token Request</h2>

<p>After receiving an authorization code from an authorization server, a client application makes a token
request. In addition to the authorization code, the token request must include the code verifier
used to compute the code challenge.</p>

<p>The name of the request parameter to specify a code verifier is code_verifier.</p>

<h2 id="pkce-token-response">PKCE Token Response</h2>

<p>A token endpoint of an authorization server that supports PKCE checks whether a token request contains
a valid code verifier.</p>

<p>Of course, this check is performed only when grant_type is authorization_code and the authorization
code contained in the token request is associated with a code challenge.</p>

<p>If a token request does not contain a valid code verifier although the conditions above meet, the
request is regarded as from a malicious application and the authorization server returns an error
response.</p>

<p>Verification is performed by comparing two code challenges.</p>

<p>One is what was contained in the authorization request and is stored in the in-memory data grid. The
other is what an authorization server computes using the code verifier contained in the token request
and the code challenge method stored in the in-memory data grid.</p>

<p>If the two code challenges are equal, the token request can be regarded as from the legitimate client
application that has made the original authorization request. Otherwise, the token request must be
regarded from a malicious application.</p>

<p>If a token request is verified, an authorization server issues an access token as usual.</p>

<h2 id="errors">Errors</h2>

<p>The following errors are PKCE specific</p>

<pre><code>ERR12033:
  statusCode: 400
  code: ERR12033
  message: INVALID_CODE_CHALLENGE_METHOD
  description: Invalid PKCE code challenge method %s.

ERR12034:
  statusCode: 400
  code: ERR12034
  message: CODE_CHALLENGE_TOO_SHORT
  description: PKCE codeChallenge length under lower limit, codeChallenge = %s
ERR12035:
  statusCode: 400
  code: ERR12035
  message: CODE_CHALLENGE_TOO_LONG
  description: PKCE codeChallenge length over upper limit, codeChallenge = %s
ERR12036:
  statusCode: 400
  code: ERR12036
  message: INVALID_CODE_CHALLENGE_FORMAT
  description: PKCE codeChallenge format is invalid, codeChallenge = %s
ERR12037:
  statusCode: 400
  code: ERR12037
  message: INVALID_CODE_VERIFIER_FORMAT
  description: PKCE codeVerifier format is invalid, codeVerifier = %s
ERR12038:
  statusCode: 400
  code: ERR12038
  message: CODE_VERIFIER_TOO_SHORT
  description: PKCE codeVerifier length under lower limit , codeVerifier = %s
ERR12039:
  statusCode: 400
  code: ERR12039
  message: CODE_VERIFIER_TOO_LONG
  description: PKCE codeVerifier length over upper limit , codeVerifier = %s
ERR12040:
  statusCode: 400
  code: ERR12040
  message: CODE_VERIFIER_MISSING
  description: PKCE codeVerifier is not specified
ERR12041:
  statusCode: 400
  code: ERR12041
  message: CODE_VERIFIER_FAILED
  description: PKCE verification failed

</code></pre>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://networknt.github.io/light-oauth2/services/openid/" title="OpenID Connect">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              OpenID Connect
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://networknt.github.io/light-oauth2/services/custom/" title="Custom Grant Type in Enterprise Edition">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Custom Grant Type in Enterprise Edition
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/networknt.github.io\/light-oauth2\/';
      var repo_id  = 'networknt\/light-oauth2';
    
    </script>

    <script src="https://networknt.github.io/light-oauth2/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

